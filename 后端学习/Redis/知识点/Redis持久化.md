#Redis操作 
## Redis持久化

持久化策略，两个策略

- RDB快照（整点切片），通过切片还原数据
- AOF日志：记录日志，可以通过命令恢复

差别
	​相同数据量下，RDB更小，因为RDB记录二进制紧凑型数据库
	​AOF记录了每条日志，RDB是间隔时间记录一次，AOF恢复数据通常更为完整，ADB更快，
	AOF对性能影响比较大，AOF和RDB是可以同时开启的，官网更推荐AOF ^2a63d7



#### 加载策略

​	![image-20231226001133134](D:\\study\img\image-20231226001133134.png)



先判断AOF是否存在，而且不会降级，aof文件不存在就会启动空库，有aof只会用aof

### RDB详解（快照）

​	dump.rdb -- 快照文件



- 怎么开启

  - save 900 1（save min times）

    900 秒里面有一次就会开启一次RDB

    也可以使用sava命令来主动使用持久化

    ![image-20231226234407734](D:\\study\img\image-20231226234407734.png)

    后台持久化，会fork一个子进程开始复制

  - 文件名字 ： dump.rdb

  - 存放位置：看redis

#### 写入流程

​	写时复制：写的时候就开始复制，谁写谁复制，fork的过程中如果有新的数据，那就这个数据自己多写一份放到线程里面



#### 面试题

- RDB本质是什么

​	本质是二进制形式的快照

- 如何触发RDB
  - RDB可以通过配置定时触发，触发时使用的是后台持久化方式
  - 也可以主动用命令触发，save和bgsave，save底层用的是阻塞式持久化，bgsave用的是后台持久化
  - 最后如果redis正常关闭，是会触发阻塞式持久化的

- RDB对主流程有什么影响
  - 用命令执行阻塞式持久化的时候，由主进程进行RDB快照保存，会阻塞主进程
  - 当执行后台持久化时，由fork出来的子进程来进行RDB快照保存
    - 数据量大的时候，会导致fork主进程操作比较耗时，从而阻塞主进程（==耗时会阻塞主进程吗？进程之间阻塞？==）
    - 由于采用了写时复制，如果在fork期间有大量写入，就会导致主线程多拷贝一份数据，消耗大量额外内存

### AOF详解

 - 是什么
   	- 记录了对应操作的命令，有自己的一套协议记录
 - 怎么开启
   	- 也是redis的配置文件，里面有一个appendonly no 改成yes
   	- 写入的文件名字就是 appendfilename “xxxx”
 - 写入？
   	- 流程：请求到来-处理请求- 写入AOF文件
    - 其中写入 AOF文件又有三个步骤
      	- 写入aof_buf
      	- write 到内核缓冲区
       - fsync到磁盘
          - 刷盘策略
            1. always 每次请求都刷盘，非常慢，但是很安全，性能开销很大
            2. everySec 每秒刷一次，足够快了，但是可能丢失一秒的数据
            3. appendfsync no 不主动刷盘，让操作系统自己刷，一半linux30秒刷一次，对性能影响比较小，但是如果崩溃，可能会丢失比较多的数据
 - aof重写（优化aof里面的重复数据，比如set a1 1 然后覆盖了 set a1 2,就会合成一个）
    - 怎么做？
      	- ![image-20231227001640372](D:\\study\img\image-20231227001640372.png)

主进程先fork一个子进程用来重写，然后同样是写时复制一份到重写缓冲区，最后用子进程合并一下

#### 面试题

​	aof不是默认开启，rdb是默认开启的

### AOF优化

- aof的不足

  - 文件体积大，加载速度慢
  - 重写性能差，重写流程复杂，代码难度高

- 混合持久化（redis配置文件中打开）

  - 当前文件变成rdb写入文件前面的部分，后面数据是AOF（5.0以后是默认打开的）

  

- 优化方案

![image-20231227003741271](D:\\study\img\image-20231227003741271.png)

优化之一,下面去掉了重写缓冲区，去掉了子线程合入两个文件，直接两个文件放一起，由manifest清单（7.0的优化)

![image-20231227004031822](D:\\study\img\image-20231227004031822.png)


